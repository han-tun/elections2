

#' Generate interactive map of election results
#'
#' Requires data from wrangle_results() function joined with a shapefile. See maps vignette for more info.
#'
#' @param joined_df sf object shapefile of election districts that's been joined with election result data.table generated by wrangle_results() function
#' @param win_col character string name of column with winner's data by Pct or Margin
#' @param lose_col character string name of column with loser's data by Pct or Margin
#' @param election_district_col character string name of column with election district data - should be name of 1st column from the wrangle_results() data frame
#' @param the_winner_palette character string of colors for leaflet colorNumeric function
#' @param the_loser_palette character string of colors for leaflet colorNumeric function
#' @param map_tiles character string for available leaflet tile providers, defaults to "CartoDB.Positron". See http://leaflet-extras.github.io/leaflet-providers/preview/ for options.
#'
#' @return leaflet map object
#' @export
#'

map_election_results <- function(joined_df, win_col, lose_col, election_district_col, the_winner_palette = "Purples", the_loser_palette = "Greens", map_tiles = "CartoDB.Positron") {
  winner_name <- gsub("(^.*?)_.*$", "\\1", win_col)
  loser_name <- gsub("(^.*?)_.*$", "\\1", lose_col)
  joined_df <- sf::st_transform(joined_df, "+proj=longlat +datum=WGS84")

  min_max_values <- range(c(joined_df[[win_col]], joined_df[[lose_col]]), na.rm = TRUE)

  winner_palette <- colorNumeric(palette = the_winner_palette, domain=c(.5001, min_max_values[2]))
  loser_palette <- colorNumeric(palette = the_loser_palette, domain=c(.5001, min_max_values[[2]]))


  winner_df <- joined_df[joined_df$Winner == winner_name,]
  loser_df <- joined_df[joined_df$Winner == loser_name,]
  tie_df <- joined_df[joined_df$Winner == "Tie",]
  na_df <- joined_df[joined_df$Winner == "Unknown",]


  winner_popup <- glue::glue("<strong>{election_district_col}: {winner_df[[election_district_col]]}</strong><br /><strong>Winner: {winner_df[['Winner']]}</strong><br /<br>{winner_name}: {scales::percent(winner_df[[win_col]])}<br />{loser_name}: {scales::percent(winner_df[[lose_col]])}")  %>%   lapply(htmltools::HTML)

  loser_popup <- glue::glue("<strong>{election_district_col}: {loser_df[[election_district_col]]}</strong><br /><strong>Winner: {loser_df[['Winner']]}</strong><br /<br>{winner_name}: {scales::percent(loser_df[[win_col]])}<br />{loser_name}: {scales::percent(loser_df[[lose_col]])}")  %>%   lapply(htmltools::HTML)


  my_map<- leaflet() %>%
    addProviderTiles(map_tiles) %>%
    addPolygons(
      data = winner_df,
      stroke = FALSE,
      smoothFactor = 0.2,
      fillOpacity = 0.8,
      color = ~winner_palette(winner_df[[win_col]]) ,
      label = winner_popup
    ) %>%
    addPolygons(
      data = loser_df,
      stroke = FALSE,
      smoothFactor = 0.2,
      fillOpacity = 0.8,
      color = ~loser_palette(loser_df[[lose_col]]) ,
      label = loser_popup
    )


  if(nrow(tie_df) > 0) {
    tie_popup <- glue::glue("<strong>{election_district_col}: {tie_df[[election_district_col]]}</strong><br /><strong>Winner: {tie_df[['Winner']]}</strong><br /<br>{winner_name}: {scales::percent(tie_df[[win_col]])}<br />{loser_name}: {scales::percent(tie_df[[lose_col]])}")  %>%   lapply(htmltools::HTML)

    my_map <- my_map %>%
      addPolygons(
        data = tie_df,
        stroke = FALSE,
        smoothFactor = 0.2,
        fillOpacity = 0.7,
        color = "white" ,
        label = tie_popup
      )
  }


  if(nrow(na_df) > 0) {
    na_popup <- glue::glue("<strong>{election_district_col}: {na_df[[election_district_col]]}</strong><br /><strong>Winner: {na_df[['Winner']]}</strong><br /<br>{winner_name}: {scales::percent(na_df[[win_col]])}<br />{loser_name}: {scales::percent(na_df[[lose_col]])}")  %>%   lapply(htmltools::HTML)

    my_map <- my_map %>%
      addPolygons(
        data = na_df,
        stroke = FALSE,
        smoothFactor = 0.2,
        fillOpacity = 0.5,
        color = "grey" ,
        label = na_popup
      )
  }

return(my_map)


# If want map to see each candidate on their own layer:

 # winner_palette <- colorNumeric(palette = the_winner_palette, domain=c(min_max_values[1], min_max_values[2]))
 #  loser_palette <- colorNumeric(palette = the_loser_palette, domain=c(min_max_values[1], min_max_values[[2]]))
 #
 #  the_popup <- glue::glue("<strong>{election_district_col}: {joined_df[[election_district_col]]}</strong><br /><strong>Winner: {joined_df[['Winner']]}</strong><br /<br>{winner_name}: {scales::percent(joined_df[[win_col]])}<br />{loser_name}: {scales::percent(joined_df[[lose_col]])}")  %>%   lapply(htmltools::HTML)
 #
 #
 #  leaflet(joined_df) %>%
 #    addProviderTiles("CartoDB.Positron") %>%
 #    addPolygons(
 #      stroke = FALSE,
 #      smoothFactor = 0.2,
 #      fillOpacity = 0.8,
 #      color = ~winner_palette(joined_df[[win_col]]),
 #      label = the_popup,
 #      group = winner_name
 #    ) %>%
 #    addPolygons(
 #      stroke = FALSE,
 #      smoothFactor = 0.2,
 #      fillOpacity = 0.8,
 #      color = ~loser_palette(joined_df[[lose_col]]),
 #      label = the_popup,
 #      group = loser_name
 #    ) %>%
 #    addLayersControl(
 #      baseGroups = c(winner_name, loser_name),
 #      position = "bottomleft",
 #      options = layersControlOptions(collapsed = FALSE)
 #
 #    )
 #


  }
